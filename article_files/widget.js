/**
 * Copyright 2014-2015 Evernote Corporation. All rights reserved.
 */
var EvernoteClipper=function(e,t){"use strict";function n(e){var t={};for(var n in e)t[n]=e[n];return t}function r(t,n,r,o){if(e.document.querySelector)return e.document.querySelector(t+"["+n+"='"+r+"']["+o+"]");for(var a=e.document.getElementsByTagName(t),i=0;i<a.length;i++)if(a[i][n]===r&&a[i][o])return a[i];return null}function o(e){return"string"==typeof e?e.replace(/[<>"'`&]/g,function(e){return"&"===e?"&amp;":"<"===e?"&lt;":">"===e?"&gt;":'"'===e?"&quot;":"'"===e?"&#39;":"`"===e?"&#96;":e}):e}function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function i(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(){for(var t=e.document.getElementsByTagName("script"),n=t.length-1;n>=0;n--){var r=t[n].src,o=/\/widget\.js(\?.*?yxbj=true(?:$|&))?/i.exec(r),a=/^https?:\/\/(?:app\.yinxiang|(?:www|(cdn1)|stage(?:-china)?)\.evernote)\.com/i.exec(r);if(o&&a)return a[1]?o[1]?b?"https://stage-china.evernote.com":"https://app.yinxiang.com":b?"https://stage.evernote.com":"https://www.evernote.com":a[0]}return"https://www.evernote.com"}function l(e){var t=e.authors;if(!t){var n=r("meta","name","author","content");n&&(t=n.content)}return t}function u(t,n){if(t.contentHTML){var r=document.createElement("iframe");r.style.cssText="display:block!important;height:1px!important;position:static!important;width:1px!important",document.body.appendChild(r),r.onload=function(e){var t=this;if(t.nodeName||(t=e.srcElement),t&&t.parentNode){var r=t.contentDocument||t.contentWindow.document;n(d(r.body)),t.parentNode.removeChild(t)}},r.attachEvent&&r.attachEvent("onload",r.onload);var o=r.contentDocument||r.contentWindow.document;o.open(),o.write("<body>"+t.contentHTML+"</body>"),o.close()}else if(t.contentId){var a=e.document.getElementById(t.contentId);a&&n(d(a))}}function d(n){if(!t.noClientSideImageConversion){var r=n.getElementsByTagName("img"),o=e.document.createElement("canvas");if("getContext"in o){e.location.origin||(e.location.origin=e.location.protocol+"//"+e.location.hostname+(e.location.port?":"+e.location.port:""));for(var a=new RegExp("^"+e.location.origin.replace(/\//g,"\\/").replace(/\./g,"\\.")),i=[],c=0;c<r.length;c++)if(r[c].naturalWidth||r[c].naturalHeight){if(a.test(r[c].src)){o.width=r[c].width||1,o.height=r[c].height||1,o.getContext("2d").drawImage(r[c],0,0,o.width,o.height);try{var l=o.toDataURL();l.length+n.outerHTML.length<w&&(r[c].src=l)}catch(e){}}}else"FIGURE"===r[c].parentNode.nodeName&&i.push(r[c].parentNode);for(var u=0;u<i.length;u++)i[u]&&i[u].parentNode&&i[u].parentNode.removeChild(i[u])}}return n.innerHTML}function m(e){if(e.dateExact)return e.dateExact;var t=e.date;if(!t){var n=r("meta","itemprop","datePublished","content");n&&(t=n.content)}var o=new Date(t)-0;return isNaN(o)&&(o=Date.parseISOString(t),isNaN(o))?null:o}function s(e){var t=e.summary;if(!t){var n=r("meta","name","article.summary","content");n?t=n.content:(n=r("meta","property","og:description","content"))&&(t=n.content)}return t}function p(t){var n=t.title;if(!n){var o=r("meta","property","og:title","content");n=o?o.content:e.document.title}return n}function f(t){var n=t.url;if(!n){var o=r("link","rel","canonical","href");if(o)n=o.href;else{var a=r("meta","property","og:url","content");n=a?a.content:e.location.href}}return n}function h(){return!(!window.navigator||!window.navigator.userAgent)&&/(?:Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone)/i.test(window.navigator.userAgent)}function v(r){var a="evernoteClipWindow";h()&&(a+=i());var d=window.open("",a,"width=360,height=336,scrollbars=yes,top="+r.screenY+",left="+r.screenX);d&&d.focus();var v=this;if(!v.nodeName)for(v=r.srcElement;!/(^|\s)evernote-clip-button($|\s)/.test(v.className);)v=v.parentNode;var g=e.EVERNOTE_CLIP_INFO[v.getAttribute("data-id")],w=p(g),y=f(g),N=s(g),E=e.document.createElement("form");E.action=c()+"/ClipNCite.action",E.method="post",E.enctype="multipart/form-data",E.encoding="multipart/form-data",E.acceptCharset="UTF-8",E.target=a;var b=e.document.createElement("input");if(b.name="title",b.value=w,E.appendChild(b),b=e.document.createElement("input"),b.name="url",b.value=y,E.appendChild(b),t.referralCode){if(t.referralCode.length>9)throw new Error("Referral code must between 0 - 9 letters, inclusive")}else t.referralCode="";(b=e.document.createElement("input")).name="code",b.value="clip_w_"+t.referralCode,E.appendChild(b);var C=e.document.createElement("textarea");C.name="content",u(g,function(e){var r=n(g);r.title=o(w),r.date=m(g),r.authors=o(l(g)),r.summary=o(N),r.body=e,r.url=o(y),C.value=t.format(r),E.appendChild(C),E.style.cssText="display:none!important",document.body.appendChild(E),E.submit(),document.body.removeChild(E)})}function g(e){if(e)try{y[N]===e?(window.clearTimeout(E),++N>=y.length?(N=0,b=!b,console.log("Evernote clipper STAGE "+(b?"enabled":"disabled"))):E=window.setTimeout(function(){N=0},400)):N=0}catch(e){console.error(e)}}var w=5e5;h()&&(w=1e5);var y=[38,38,40,40,37,39,37,39,66,65],N=0,E=null,b=!1;Date.parseISOString=function(e){function t(e,t){var n=[0,31,59,90,120,151,181,212,243,273,304,334,365],r=t>1?1:0;return n[t]+Math.floor((e-1969+r)/4)-Math.floor((e-1901+r)/100)+Math.floor((e-1601+r)/400)+365*(e-1970)}var n=/^(\d{4}|[\+\-]\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2})(?::(\d{2})(?:(\.\d{1,}))?)?(Z|(?:([\-\+])(\d{2}):(\d{2})))?)?)?)?$/.exec(e);if(n){var r,o=Number(n[1]),a=Number(n[2]||1)-1,i=Number(n[3]||1)-1,c=Number(n[4]||0),l=Number(n[5]||0),u=Number(n[6]||0),d=Math.floor(1e3*Number(n[7]||0)),m=Boolean(n[4]&&!n[8]),s="-"===n[9]?1:-1,p=Number(n[10]||0),f=Number(n[11]||0);return c<(l>0||u>0||d>0?24:25)&&l<60&&u<60&&d<1e3&&a>-1&&a<12&&p<24&&f<60&&i>-1&&i<t(o,a+1)-t(o,a)&&(r=60*(24*(t(o,a)+i)+c+p*s),r=1e3*(60*(r+l+f*s)+u)+d,m&&(r=function(e){return Number(new Date(1970,0,1,0,0,0,e))}(r)),-864e13<=r&&r<=864e13)?r:NaN}return Date.parse.apply(this,arguments)},window.onkeyup=function(e){g(e.which||e.keyCode||0)};for(var C=function(e,t){if(e.getElementsByClassName)return e.getElementsByClassName(t);if(e.querySelectorAll)return e.querySelectorAll("."+t);for(var n=[],r=new RegExp("(^|\\s)"+t+"(\\s|$)"),o=e.getElementsByTagName("*"),a=0;a<o.length;a++)r.test(o[a].className)&&n.push(o[a]);return n}(e.document,"evernote-clip-button"),x=0;x<C.length;x++)C[x].addEventListener?C[x].addEventListener("click",v):C[x].attachEvent("onclick",v);return t.clickHandler=v,t}(window,EvernoteClipper||{});